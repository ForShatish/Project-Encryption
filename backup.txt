#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// Function to generate random password
void generatePassword(char *password) {
    const char charset[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    int length = 8;
    
    srand(time(NULL));
    
    for (int i = 0; i < length; i++) {
        int index = rand() % (sizeof(charset) - 1);
        password[i] = charset[index];
    }
    password[length] = '\0';
}

// Function to check if username already exists
int usernameExists(char *username) {
    FILE *file = fopen("users.txt", "r");
    if (file == NULL) {
        return 0; // File doesn't exist, so username doesn't exist
    }
    
    char stored_user[50], stored_pass[50];
    int stored_key;
    
    while (fscanf(file, "%s %s %d", stored_user, stored_pass, &stored_key) != EOF) {
        if (strcmp(username, stored_user) == 0) {
            fclose(file);
            return 1; // Username exists
        }
    }
    
    fclose(file);
    return 0; // Username doesn't exist
}

// Function to create new account
void createAccount() {
    char username[50];
    char password[50];
    int key;
    
    printf("\n");
    printf("========================================\n");
    printf("          CREATE NEW ACCOUNT            \n");
    printf("========================================\n\n");
    
    printf("Enter Username: ");
    scanf("%s", username);
    
    // Check if username already exists
    if (usernameExists(username)) {
        printf("\n[ERROR] Username already exists! Please try again.\n");
        return;
    }
    
    printf("Enter Encryption Key (1-26): ");
    scanf("%d", &key);
    
    if (key < 1 || key > 26) {
        printf("\n[ERROR] Invalid key! Must be between 1 and 26.\n");
        return;
    }
    
    // Generate random password
    generatePassword(password);
    
    // Save to file
    FILE *file = fopen("users.txt", "a");
    if (file == NULL) {
        printf("\n[ERROR] Could not create account!\n");
        return;
    }
    
    fprintf(file, "%s %s %d\n", username, password, key);
    fclose(file);
    
    printf("\n========================================\n");
    printf("      ACCOUNT CREATED SUCCESSFULLY!     \n");
    printf("========================================\n");
    printf("Username: %s\n", username);
    printf("Password: %s\n", password);
    printf("Encryption Key: %d\n", key);
    printf("\n[IMPORTANT] Please remember your password!\n");
    printf("========================================\n\n");
}

// Function to login to account
int loginAccount() {
    char username[50];
    char password[50];
    
    printf("\n");
    printf("========================================\n");
    printf("            LOGIN TO ACCOUNT            \n");
    printf("========================================\n\n");
    
    printf("Enter Username: ");
    scanf("%s", username);
    
    printf("Enter Password: ");
    scanf("%s", password);
    
    // Verify credentials
    FILE *file = fopen("users.txt", "r");
    if (file == NULL) {
        printf("\n[ERROR] No accounts found!\n");
        return 0;
    }
    
    char stored_user[50], stored_pass[50];
    int stored_key;
    
    while (fscanf(file, "%s %s %d", stored_user, stored_pass, &stored_key) != EOF) {
        if (strcmp(username, stored_user) == 0) {
            if (strcmp(password, stored_pass) == 0) {
                fclose(file);
                printf("\n========================================\n");
                printf("       LOGIN SUCCESSFUL! WELCOME!       \n");
                printf("========================================\n\n");
                return 1; // Login successful
            } else {
                fclose(file);
                printf("\n[ERROR] Incorrect password!\n");
                return 0;
            }
        }
    }
    
    fclose(file);
    printf("\n[ERROR] Username not found!\n");
    return 0;
}

// Function to display main menu
void displayMenu() {
    printf("\t\t\t\t\t========================================\n");
    printf("\t\t\t\t\t        MESSAGE ENCRYPTION SYSTEM          \n");
    printf("\t\t\t\t\t========================================\n\n");
    printf("\t\t\t\t\t\t   1. CREATE ACCOUNT\n");
    printf("\t\t\t\t\t\t   2. LOGIN TO ACCOUNT\n");
    printf("\t\t\t\t\t\t   3. EXIT\n\n");
    printf("\t\t\t\t\t========================================\n\n");
}

int main() {
    int command;
    int running = 1;

    do{
        displayMenu();
        printf("ENTER YOUR COMMAND : ");
        scanf("%d", &command);
        
        switch(command) {
            case 1:
                createAccount();
                break;
            case 2:
                if (loginAccount()) {
                    printf("(Step 2 features will be added here)\n\n");
                }
                break;
            case 3:
                printf("\n========================================\n");
                printf("   Thank you for using our system!      \n");
                printf("========================================\n");
                running = 0;
                break;
            default:
                printf("\n[ERROR] Invalid command! Please try again.\n\n");
                
        }
    }
    
    while (running) ;
    
    return 0;
}
